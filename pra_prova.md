-- === TABELA: categorias ===
CREATE TABLE IF NOT EXISTS categorias (
    categoria_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    CONSTRAINT uq_categorias_nome UNIQUE (nome),
    CONSTRAINT ck_categorias_nome_nao_vazio CHECK (char_length(trim(nome)) > 0)
);

-- === TABELA: formas_pagamento ===
CREATE TABLE IF NOT EXISTS formas_pagamento (
    forma_pagamento_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    codigo_externo VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    CONSTRAINT uq_formas_pagamento_nome UNIQUE (nome),
    CONSTRAINT ck_formas_pagamento_nome_nao_vazio CHECK (char_length(trim(nome)) > 0)
);

-- === TABELA: lancamentos ===
CREATE TABLE IF NOT EXISTS lancamentos (
    lancamento_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    descricao TEXT,
    valor NUMERIC(12,2) NOT NULL,
    data_lancamento DATE NOT NULL,
    categoria_id INT NOT NULL,
    forma_pagamento_id INT NOT NULL,
    observacao TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    CONSTRAINT ck_lancamentos_valor_nao_negativo CHECK (valor >= 0),
    CONSTRAINT fk_lancamentos_categoria FOREIGN KEY (categoria_id)
        REFERENCES categorias (categoria_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    CONSTRAINT fk_lancamentos_forma_pagamento FOREIGN KEY (forma_pagamento_id)
        REFERENCES formas_pagamento (forma_pagamento_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

-- Categorias
INSERT INTO categorias (nome) VALUES
('Alimentação'),
('Transporte'),
('Energia Elétrica'),
('Água'),
('Internet');

-- Formas de pagamento
INSERT INTO formas_pagamento (nome) VALUES
('PIX'),
('Cartão de Crédito'),
('Débito'),
('Dinheiro');

-- Lançamentos
INSERT INTO lancamentos (descricao, valor, data_lancamento, categoria_id, forma_pagamento_id) VALUES
('Supermercado - Mercadão', 250.75, '2025-10-01', 1, 2),
('Conta de Luz - CEMIG', 120.40, '2025-09-25', 3, 3),
('Assinatura Internet', 99.90, '2025-09-30', 5, 2),
('Táxi aeroporto', 68.00, '2025-10-02', 2, 1);

SELECT * FROM lancamentos;
SELECT
    l.descricao,
    l.valor,
    l.data_lancamento
FROM
    lancamentos l
ORDER BY
    l.data_lancamento ASC;

UPDATE lancamentos
SET valor = ROUND(valor * 1.05, 2)
WHERE data_lancamento < '2025-10-01';

SELECT
    c.nome,
    l.descricao,
    l.valor
FROM
    categorias c
LEFT JOIN lancamentos l
    ON l.categoria_id = c.categoria_id
JOIN formas_pagamento fp
    ON l.forma_pagamento_id = fp.forma_pagamento_id;

SELECT
    c.nome,
    SUM(l.valor) AS total_categoria
FROM
    lancamentos l
JOIN categorias c
    ON l.categoria_id = c.categoria_id
GROUP BY
    c.nome
ORDER BY
    total_categoria DESC;

SELECT
    c.nome,
    SUM(l.valor) AS total_categoria
FROM
    categorias c
LEFT JOIN lancamentos l
    ON l.categoria_id = c.categoria_id
GROUP BY
    c.nome
ORDER BY
    total_categoria DESC;

SELECT
    fp.nome AS forma_pagamento,
    SUM(l.valor) AS total_gasto
FROM
    lancamentos l
JOIN
    formas_pagamento fp
    ON l.forma_pagamento_id = fp.forma_pagamento_id
WHERE
    fp.nome = 'Cartão de Crédito'   -- filtro por forma de pagamento
GROUP BY
    fp.nome
ORDER BY
    total_gasto DESC;



SELECT
    c.nome,
    SUM(l.valor) AS total_cartao
FROM
    categorias c
JOIN forma_pagamento fp
    ON c.categoria_id = f.categoria_id
GROUP BY
    c.nome
ORDER BY
    total_valor ASC;


SELECT
    fp.nome,
    l.descricao,
    l.valor,
    c.nome
FROM 
    lancamentos l
JOIN
    formas_pagamento fp
    ON l.forma_pagamento_id = fp.forma_pagamento_id
JOIN
    categorias c
    ON l.categoria_id = c.categoria_id
WHERE
    fp.nome = 'PIX' AND c.nome = 'Alimentação'; 

